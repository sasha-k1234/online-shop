<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>

<body>
    <form>
        <input class="form-control" placeholder="title" id="title" />
        <input class="form-control" placeholder="price" id="price" />
        <input class="form-control" placeholder="desc" id="desc" />
        <button id="btn" class="btn btn-primary" onclick=addProducts>Submit</button>
    </form>
    <ul id="products">
    </ul>
    <script>
        function newLi(element) {
            const delBtn = document.createElement('button');
            delBtn.innerText= 'X';
            delBtn.setAttribute('class','btn btn-danger');
            const li = document.createElement("li");
            delBtn.onclick = ()=>deleteProducts(element.id);
            li.innerHTML = `ID: ${element.id}  TITLE:${element.title} Price:${element.price} Desc:${element.desc}  `;
            li.append(delBtn);
            return li;
        }

        async function getProducts() {
            try {
                const response = await fetch("/products");
                const products = await response.json();
                const ul = document.getElementById('products');
                products.forEach(element => {
                    ul.append(newDiv(element));
                });
            } catch (error) {
                console.error(error.message);
            }
        };

        const btn = document.getElementById('btn');
        btn.onclick = addProducts;
        let products = [];
        async function addProducts(e) {
            e.preventDefault();
            const ul = document.getElementById('products');
            const li = document.createElement('li');
            let title = document.getElementById('title').value;
            let price = document.getElementById('price').value;
            let desc = document.getElementById('desc').value;
            const product = {
                title: title,
                price: price,
                desc: desc
            };
            try {
                const response = await fetch("/add-products", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(product),
                });
                if (response.ok) {
                    const res = await response.json();
                    products.push(res);

                    // li.innerHTML = (` ID:${res.id} Title: ${product.title} Price: ${product.price} Desc: ${product.desc}`);
                   let li = newLi(res)
                    ul.append(li);
                }
                else {
                    throw new Error(response.statusText);
                }
                // if (!response.ok) {
                //     throw new Error(response.statusText);
                
                // }
            }
            catch (error) {
                console.error(error);
            }
        };

        async function deleteProducts(id) {
            
            try{
                const response = await fetch(`/delete/${id}`,{
                    method: 'DELETE',
                    headers:{
                        "Content-Type":"application/json"
                    }
                })
            } catch (err){
                console.error(err);
            }
          products = products.filter(product=>product.id !== id);
          redraw();
        }

        function redraw() {
            const ul = document.getElementById('products');
                ul.innerHTML = '';
            for(let i =0;i<products.length;i++) {
                ul.append(newLi(products[i]))
            }
        }
    </script>
</body>

</html>